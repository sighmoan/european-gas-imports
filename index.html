<html>
<head>

<link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/theleagueof/ostrich-sans/master/webfonts/ostrich-sans.css">
<style>

text,h4 {
	font-family:'Ostrich Sans';
}

h1 {
	font-family:'helvetica';
	font-weight:'regular';
}
</style>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>

/*

TODO:
- Responsive (scales with screen size)
	- Generate exporter labels [x]
	- Generate importer labels [x]
	- Calculate x values from width [x]
	- Redraw graph on change of screen size [x]
	- Use full floats and round in JS [ ]
- Auto generate labels [x]
- Improve colouration 
- Vanquish magic numbers
- Tweak label placement to account for line height
- Set a timer for the fadeout [x]

*/


var Importers = [
	['DE', 86.8, 'Germany',0],
	['IT', 59.7, 'Italy',0],
	['UK', 35.4, 'United Kingdom',0],
	['FR', 35.0, 'France',0],
	['TR', 34.9, 'Turkey',0],
	['BE', 26.2, 'Belgium',0],
	['NL', 14.5, 'Netherlands',0],
	['SP', 13.3, 'Spain',0],
	['PL', 10.9, 'Poland',0],
	['CZ', 10.0, 'Czech Republic',0],
	['AT', 7.6, 'Austria',0],
	['HR', 5.9, 'Hungary',0],
	['IR', 5.3, 'Ireland',0],
]

var Exporters = [
	['RU', 185.9, 'Russia', 0],
	['NO', 106.6, 'Norway', 0],
	['NL', 54.5, 'Netherlands', 0],
	['UK', 12.0, 'United Kingdom', 0],
	['AL', 34.8, 'Algeria', 0],
	['LB', 6.5, 'Libya', 0]
]

var Paths = [
	['RUDE', 30, '#FF3B2F', '16.1 %', '34.6 %'],
	['RUIT', 14, '#FF3B2F', '7.3 %', '22.8 %'],
	['RUFR', 7, '#FF3B2F', '3.9 %'],
	['RUTR', 25, '#FF3B2F', '13.1 %'],
	['RUBE', 7, '#FF3B2F', '3.9 %'],
	['RUNL', 2, '#FF3B2F', '1.1 %'],
	['RUPL', 9, '#FF3B2F', '4.8 %'],
	['RUCZ', 7, '#FF3B2F', '3.6 %'],
	['RUAT', 5, '#FF3B2F', '2.5 %'],
	['RUHR', 5,	 '#FF3B2F', '2.6 %'],
	['NLDE', 25, '#76B6CC', '', '29.1 %'],
	['NLIT', 7,  '#76B6CC', '', '11.4 %'],
	['NLUK', 7,  '#76B6CC'],
	['NLFR', 9,  '#76B6CC'],
	['NLBE', 5,  '#76B6CC'],
	['NODE', 31, '#71CC58', '', '35.4 %'],
	['NOIT', 6, '#71CC58', '', '10.6 %'],
	['NOUK', 27, '#71CC58'],
	['NOFR',18, '#71CC58'],
	['NOBE', 9, '#71CC58'],
	['NONL', 8, '#71CC58'],
	['NOSP', 2, '#71CC58'],
	['NOCZ', 3, '#71CC58'],
	['NOAT', 1, '#71CC58'],
	['UKBE', 5],
	['UKNL', 2],
	['UKIR', 5],
	['ALIT', 21],
	['ALSP', 10]
]

function drawGraphs(svg, height, width) {

	svg.empty();

	var cImports = [
		['DE',50],
		['IT',147],
		['UK',217],
		['FR',262],
		['TR',307],	
		['BE',352],
		['NL',388],
		['SP',413],
		['PL',436],
		['CZ',457],
		['AT',477],
		['HR',495],
		['IR',511]
	];
	var cExports = [
		['RU', 50],
		['NO',246],
		['NL',363],
		['AL',428],
		['UK',473],
		['IR',495],
		['LB',513]
	];

	var y2 = 50;
	var xExport = 200;
	var xImport = width - 300;

	for(var i = 0; i < Exporters.length; i++) {
		var x1 = xExport;
		var x2 = xExport;

		console.log('Generating '+Exporters[i])

		//calculate y1
		var y1 = y2;
		console.log(y1);
		//calculate y2
		y2 = y1 + Math.round(Exporters[i][1]);
		console.log(y2);
		//draw line
		svg.append('line')
			.attr('x1', x1)
			.attr('x2', x2)
			.attr('y1', y1)
			.attr('y2', y2)
			.attr('stroke-width', 2)
			.attr('stroke', 'grey');
		//calculate points for label

		var my = (y1 + y2) / 2;
		//todo: tweak with baseline

		svg.append('text')
			.attr('x', x1 - 120)
			.attr('y', my)
			.text(Exporters[i][2])
			.attr('class', 'export')
			.attr('id', Exporters[i][0]);

		Exporters[i][3] = y1;

		console.log(Exporters[i]);


		y2 += 10;
	}

	y2 = 50;

	for(var i = 0; i < Importers.length; i++) {
		var x1 = xImport;
		var x2 = xImport;

		console.log('Generating '+Importers[i])

		//calculate y1
		var y1 = y2;
		console.log(y1);
		//calculate y2
		y2 = y1 + Math.round(Importers[i][1]);
		console.log(y2);
		//draw line
		svg.append('line')
			.attr('x1', x1)
			.attr('x2', x2)
			.attr('y1', y1)
			.attr('y2', y2)
			.attr('stroke-width', 2)
			.attr('stroke', 'grey');
		//calculate points for label

		var my = (y1 + y2) / 2;
		//todo: tweak with baseline

		svg.append('text')
			.attr('x', x1 + 120)
			.attr('y', my)
			.attr('text-anchor', 'end')
			.text(Importers[i][2])
			.attr('class', 'import')
			.attr('id', Importers[i][0]);

		Importers[i][3] = y1;

		y2 += 10;
	}

	for(var i = 0; i < Paths.length; i++) {
		var data = 'M';
		var y1 = -1;
		var y2 = -1;

		
		
		//get name of path
		var name = Paths[i][0];
		//console.log('Name of path is '+name);
		//get first 2 characters of name
		var exportCountry = name.substring(0, 2);
		//console.log('export country is '+exportCountry);
		//get current cImports for that country code
		var exportCountryIndex = 0;

		for(exportCountryIndex = 0; exportCountryIndex < Exporters.length; exportCountryIndex++) {
			if(Exporters[exportCountryIndex][0] == exportCountry) {
				y1 = Exporters[exportCountryIndex][3];
				console.log('found export country - ' + Exporters[exportCountryIndex]);
				break;
			}
		}

		/*for(exportCountryIndex = 0; exportCountryIndex < cExports.length; exportCountryIndex++) {
			if(cExports[exportCountryIndex][0] == exportCountry) {
				y1 = cExports[exportCountryIndex][1];
				console.log('found export country - ' + cExports[exportCountryIndex]);
				break;
			}
		}
		if(y1 == -1) {
			y1 = 0;
			cExports.push([exportCountry, 0]);
			exportCountryIndex = cExports.length - 1;
		}*/
		//console.log('y1 is '+y1);
		//console.log('export country index is '+exportCountryIndex);

		//get last 2 characters of name
		var importCountry = name.substring(2, 4);
		//get current cExports for that country code
		var importCountryIndex = 0;
		//console.log('import country is '+importCountry);
		for(importCountryIndex = 0; importCountryIndex < Importers.length; importCountryIndex++) {
			if(Importers[importCountryIndex][0] == importCountry) {
				y2 = Importers[importCountryIndex][3];
				break;
			}
		}
		/*for(importCountryIndex = 0; importCountryIndex < cImports.length; importCountryIndex++) {
			if(cImports[importCountryIndex][0] == importCountry) {
				y2 = cImports[importCountryIndex][1];
				break;
			}
		}
		if(y2 == -1) {
			y2 = 0;
			cImports.push([importCountryIndex, 0]);
			importCountryIndex = cImports.length - 1;
		}*/
		//console.log('y2 is '+y2);
		//console.log('import country index is '+importCountryIndex);

		var mx = xImport - xExport;

		data += ' '+ xExport + ' ' + y1;
		
		data += ' C '+mx+','+y1+' '+mx+','+y2+' '+xImport+','+y2;

		
		//add LHS labels



		

		
		//add width to y2
		y2 += Paths[i][1]
		data += ' L '+xImport+' ' + y2;

		//add bezier control points

		y1 += Paths[i][1]
		data += ' C '+mx+','+y2+' '+mx+','+y1+' '+xExport+','+y1;
		

		Exporters[exportCountryIndex][3] = y1;
		//console.log('export country ' +exportCountryIndex+' y is ' + y1);
		Importers[importCountryIndex][3] = y2;

		//console.log('export countries are' + cExports)

		//console.log(name+' is '+data);



		svg.append('path')
			.attr('d', data)
			.attr('id', name)
			.attr('stroke', 'none')
			.attr('fill', Paths[i][2]);

		var importPosition = y1 - (Paths[i][1] / 2) + 7;

		
		var pcImports = (Paths[i][1] / Importers[importCountryIndex][1] * 100).toFixed(1);
		svg.append('text')
			.attr('x', xExport - 30)
			.attr('y', importPosition)
			.attr('class', 'axisLabel import'+importCountry)
			.text(pcImports + " %");

		var pcExports = (Paths[i][1] / Exporters[exportCountryIndex][1] * 100).toFixed(1);
		svg.append('text')
			.attr('x', xImport + 10)
			.attr('y', y2 - (Paths[i][1] / 2) + 7)
			.attr('class', 'axisLabel export'+exportCountry)
			.text(pcExports + " %");



	}

	$('.axisLabel').hide();
}

$(document).ready(function() {

	var timer = 0;

	console.log($('#chart').width());

	$( window ).resize(function() {
		$('#chart').empty();
		drawGraphs(d3.select('#chart'), 1000, $('#chart').width());

		$('.export').mouseover(function() {
			var exportCode = '.export' + $(this).attr('id')
			window.clearInterval(timer);
	
			var expr = '[id^=' + $(this).attr('id') + ']';
	
			$('path').not(expr).fadeOut();
			$('.axisLabel').not(exportCode).fadeOut();
	
			$(exportCode).fadeIn();
			$(expr).fadeIn();
		});

		$('.export, .import').mouseout(function() {
			timer = setInterval(function() {			
				$('path').fadeIn();
				$('.axisLabel').fadeOut();
				window.clearInterval(timer);
			}, 750);
		});

		$('.import').mouseover(function() {
			window.clearInterval(timer);

		var thisID= $(this).attr('id');
		var importCode = '.import' + thisID;
		console.log(importCode);

		var expr = '[id$=' + $(this).attr('id') + ']';

		$('path').not(expr).fadeOut();
		$('.axisLabel').not(importCode).fadeOut();
		
		$(importCode).fadeIn();
		$(expr).fadeIn();		
		});
	});

	$(window).resize();

})

</script>

</head>
<body>
<h1>EUROPEAN NATURAL GAS IMPORTS</h1>
<h4>One pixel = 1 billion cubic metres (2012 figures)<br/>Source: British Petroleum World Energy Report 2013<br/>Hover for detail</h4>

<svg id='chart' style='width:100%; height:80%; min-height:1000px; min-width:500px'>
</svg>
</body>
</html>