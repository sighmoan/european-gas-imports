<html>
<head>

<link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/theleagueof/ostrich-sans/master/webfonts/ostrich-sans.css">
<style>

text,h4 {
	font-family:'Ostrich Sans';
}

h1 {
	font-family:'helvetica';
	font-weight:'regular';
}
</style>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>

/*

TODO:
- Responsive (scales with screen size)
	- Generate exporter labels [ ]
	- Generate importer labels [x]
	- Calculate x values from width [x]
	- Redraw graph on change of screen size [ ]
	- Use full floats and round in JS [ ]
- Auto generate labels
- Improve colouration
- Vanquish magic numbers
- 

*/


var Importers = [
	['DE', 86.8, 'Germany'],
	['IT', 59.7, 'Italy'],
	['UK', 35.4, 'United Kingdom'],
	['FR', 35.0, 'France'],
	['TR', 34.9, 'Turkey'],
	['BE', 26.2, 'Belgium'],
	['NL', 14.5, 'Netherlands'],
	['SP', 13.3, 'Spain'],
	['PL', 10.9, 'Poland'],
	['CZ', 10.0, 'Czech Republic'],
	['AT', 7.6, 'Austria'],
	['HR', 5.9, 'Hungary'],
	['IR', 5.3, 'Ireland']
]

var Exporters = [
	['RU', 185.9, 'Russia'],
	['NO', 106.6, 'Norway'],
	['NL', 54.5, 'Netherlands'],
	['UK', 12.0, 'United Kingdom'],
	['AL', 34.8, 'Algeria'],
	['LB', 6.5, 'Libya'],
]

var Paths = [
	['RUDE', 30, '#FF3B2F', '16.1 %', '34.6 %'],
	['RUIT', 14, '#FF3B2F', '7.3 %', '22.8 %'],
	['RUFR', 7, '#FF3B2F', '3.9 %'],
	['RUTR', 25, '#FF3B2F', '13.1 %'],
	['RUBE', 7, '#FF3B2F', '3.9 %'],
	['RUNL', 2, '#FF3B2F', '1.1 %'],
	['RUPL', 9, '#FF3B2F', '4.8 %'],
	['RUCZ', 7, '#FF3B2F', '3.6 %'],
	['RUAT', 5, '#FF3B2F', '2.5 %'],
	['RUHR', 5, '#FF3B2F', '2.6 %'],
	['NLDE', 25, '#76B6CC', '', '29.1 %'],
	['NLIT', 7,  '#76B6CC', '', '11.4 %'],
	['NLUK', 7,  '#76B6CC'],
	['NLFR', 9,  '#76B6CC'],
	['NLBE', 5,  '#76B6CC'],
	['NODE', 31, '#71CC58', '', '35.4 %'],
	['NOIT', 6, '#71CC58', '', '10.6 %'],
	['NOUK', 27, '#71CC58'],
	['NOFR',18, '#71CC58'],
	['NOBE', 9, '#71CC58'],
	['NONL', 8, '#71CC58'],
	['NOSP', 2, '#71CC58'],
	['NOCZ', 3, '#71CC58'],
	['NOAT', 1, '#71CC58'],
	['UKBE', 5],
	['UKNL', 2],
	['UKIR', 5],
	['ALIT', 21],
	['ALSP', 10]
]

function drawGraphs(svg, height, width) {

	svg.empty();

	var cImports = [
		['DE',50],
		['IT',147],
		['UK',217],
		['FR',262],
		['TR',307],	
		['BE',352],
		['NL',388],
		['SP',413],
		['PL',436],
		['CZ',457],
		['AT',477],
		['HR',495],
		['IR',511]
	];
	var cExports = [
		['RU', 50],
		['NO',246],
		['NL',363],
		['AL',428],
		['UK',473],
		['IR',495],
		['LB',513]
	];

	var y2 = 50;
	var xExport = 200;
	var xImport = width - 300;

	for(var i = 0; i < Exporters.length; i++) {
		var x1 = xExport;
		var x2 = xExport;

		console.log('Generating '+Exporters[i])

		//calculate y1
		var y1 = y2;
		console.log(y1);
		//calculate y2
		y2 = y1 + Math.round(Exporters[i][1]);
		console.log(y2);
		//draw line
		svg.append('line')
			.attr('x1', x1)
			.attr('x2', x2)
			.attr('y1', y1)
			.attr('y2', y2)
			.attr('stroke-width', 2)
			.attr('stroke', 'grey');
		//calculate points for label

		var my = (y1 + y2) / 2;
		//todo: tweak with baseline

		svg.append('text')
			.attr('x', x1 - 100)
			.attr('y', my)
			.text(Exporters[i][2])
			.attr('class', 'export')
			.attr('id', Exporters[i][0]);

		y2 += 10;
	}

	y2 = 50;

	for(var i = 0; i < Importers.length; i++) {
		var x1 = xImport;
		var x2 = xImport;

		console.log('Generating '+Importers[i])

		//calculate y1
		var y1 = y2;
		console.log(y1);
		//calculate y2
		y2 = y1 + Math.round(Importers[i][1]);
		console.log(y2);
		//draw line
		svg.append('line')
			.attr('x1', x1)
			.attr('x2', x2)
			.attr('y1', y1)
			.attr('y2', y2)
			.attr('stroke-width', 2)
			.attr('stroke', 'grey');
		//calculate points for label

		var my = (y1 + y2) / 2;
		//todo: tweak with baseline

		svg.append('text')
			.attr('x', x1 + 20)
			.attr('y', my)
			.text(Importers[i][2])
			.attr('class', 'import')
			.attr('id', Importers[i][0]);

		y2 += 10;
	}

	for(var i = 0; i < Paths.length; i++) {
		var data = 'M';
		var y1 = -1;
		var y2 = -1;

		
		
		//get name of path
		var name = Paths[i][0];
		//console.log('Name of path is '+name);
		//get first 2 characters of name
		var exportCountry = name.substring(0, 2);
		//console.log('export country is '+exportCountry);
		//get current cImports for that country code
		var exportCountryIndex = 0;
		for(exportCountryIndex = 0; exportCountryIndex < cExports.length; exportCountryIndex++) {
			if(cExports[exportCountryIndex][0] == exportCountry) {
				y1 = cExports[exportCountryIndex][1];
				console.log('found export country - ' + cExports[exportCountryIndex]);
				break;
			}
		}
		if(y1 == -1) {
			y1 = 0;
			cExports.push([exportCountry, 0]);
			exportCountryIndex = cExports.length - 1;
		}
		//console.log('y1 is '+y1);
		//console.log('export country index is '+exportCountryIndex);

		//get last 2 characters of name
		var importCountry = name.substring(2, 4);
		//get current cExports for that country code
		var importCountryIndex = 0;
		//console.log('import country is '+importCountry);
		for(importCountryIndex = 0; importCountryIndex < cImports.length; importCountryIndex++) {
			if(cImports[importCountryIndex][0] == importCountry) {
				y2 = cImports[importCountryIndex][1];
				break;
			}
		}
		if(y2 == -1) {
			y2 = 0;
			cImports.push([importCountryIndex, 0]);
			importCountryIndex = cImports.length - 1;
		}
		//console.log('y2 is '+y2);
		//console.log('import country index is '+importCountryIndex);

		var mx = xImport - xExport;

		data += ' '+ xExport + ' ' + y1;
		
		data += ' C '+mx+','+y1+' '+mx+','+y2+' '+xImport+','+y2;

		
		//add LHS labels



		

		
		//add width to y2
		y2 += Paths[i][1]
		data += ' L '+xImport+' ' + y2;

		//add bezier control points

		y1 += Paths[i][1]
		data += ' C '+mx+','+y2+' '+mx+','+y1+' '+xExport+','+y1;
		

		cExports[exportCountryIndex][1] = y1;
		//console.log('export country ' +exportCountryIndex+' y is ' + y1);
		cImports[importCountryIndex][1] = y2;

		//console.log('export countries are' + cExports)

		//console.log(name+' is '+data);

		svg.append('path')
			.attr('d', data)
			.attr('id', name)
			.attr('stroke', 'none')
			.attr('fill', Paths[i][2]);

		var importPosition = y1 - (Paths[i][1] / 2) + 7;

		svg.append('text')
			.attr('x', xExport - 30)
			.attr('y', importPosition)
			.attr('class', 'axisLabel import'+importCountry)
			.text(Paths[i][4]);

		svg.append('text')
			.attr('x', xImport + 10)
			.attr('y', y2 - (Paths[i][1] / 2) + 7)
			.attr('class', 'axisLabel export'+exportCountry)
			.text(Paths[i][3]);



	}

	$('.axisLabel').hide();
}

$(document).ready(function() {

	console.log($('#chart').width());


//	drawGraphs(d3.select('#chart'), 1000, $('#chart').width());
	

	$( window ).resize(function() {
		$('#chart').empty();
		drawGraphs(d3.select('#chart'), 1000, $('#chart').width());

		$('.export').mouseover(function() {
			var exportCode = '.export' + $(this).attr('id')
	
			var expr = '[id^=' + $(this).attr('id') + ']';
	
			$('path').not(expr).fadeOut();
			$('.axisLabel').not(exportCode).fadeOut();
	
			$(exportCode).fadeIn();
			$(expr).fadeIn();
		});

		$('.export, .import').mouseout(function() {
			/* possible to delay? amazon-menu-like logic*/
			$('path').fadeIn();
			$('.axisLabel').fadeOut();
		});

		$('.import').mouseover(function() {

		var thisID= $(this).attr('id');
		var importCode = '.import' + thisID;
		console.log(importCode);

		var expr = '[id$=' + $(this).attr('id') + ']';

		$('path').not(expr).fadeOut();
		$('.axisLabel').not(importCode).fadeOut();
		
		$(importCode).fadeIn();
		$(expr).fadeIn();		
		});
	});

	$(window).resize();

	



})

</script>

</head>
<body>
<h1>EUROPEAN NATURAL GAS IMPORTS</h1>
<h4>One pixel = 1 billion cubic metres (2012 figures)<br/>Source: British Petroleum World Energy Report 2013<br/>Hover for detail</h4>

<!-- SCALE: 1 pixel = -->
<svg id='chart' style='width:100%; height:80%; min-height:1000px; min-width:500px'>

	<!--<text x='20' y='168' id='RU' class='export'>Russia</text>
	<line x1='200' x2='200' y1='50' y2='236' style='stroke:grey;stroke-width:2' />

	<text x='20' y='300' id='NO' class='export'>Norway</text>
	<line x1='200' x2='200' y1='246' y2='353' style='stroke:grey;stroke-width:2' />

	<text x='20' y='391' id='NL' class='export'>Netherlands</text>
	<line x1='200' x2='200' y1='363' y2='418' style='stroke:grey;stroke-width:2' />

	<text x='20' y='434' id='AL' class='export'>Algeria</text>
	<line x1='200' x2='200' y1='428' y2='463' style='stroke:grey;stroke-width:2' />

	<text x='20' y='479' id='UK' class='export'>United Kingdom</text>
	<line x1='200' x2='200' y1='473' y2='485' style='stroke:grey;stroke-width:2' />

	<text x='20' y='499' id='IR' class='export'>Iran</text>
	<line x1='200' x2='200' y1='495' y2='503' style='stroke:grey;stroke-width:2' />

	<text x='20' y='517' id='LB' class='export'>Libya</text>
	<line x1='200' x2='200' y1='513' y2='520' style='stroke:grey;stroke-width:2' />-->



<!--	<text x='850' y='94' id='DE' class='import'>Germany</text>
	<line x1='800' x2='800' y1='50' y2='137' style='stroke:grey;stroke-width:2' />

	<text x='850' y='177' id='IT' class='import'>Italy</text>
	<line x1='800' x2='800' y1='147' y2='207' style='stroke:grey;stroke-width:2' />

	<text x='850' y='235' id='UK' class='import'>United Kingdom</text>
	<line x1='800' x2='800' y1='217' y2='252' style='stroke:grey;stroke-width:2' />

	<text x='850' y='280' id='FR' class='import'>France</text>
	<line x1='800' x2='800' y1='262' y2='297' style='stroke:grey;stroke-width:2' />

	<text x='850' y='325' id='TR' class='import'>Turkey</text>
	<line x1='800' x2='800' y1='307' y2='342' style='stroke:grey;stroke-width:2' />
	
	<text x='850' y='365' id='BE' class='import'>Belgium</text>
	<line x1='800' x2='800' y1='352' y2='378' style='stroke:grey;stroke-width:2' />

	<text x='850' y='396' id='NL' class='import'>Netherlands</text>
	<line x1='800' x2='800' y1='388' y2='403' style='stroke:grey;stroke-width:2' />

	<text x='850' y='420' id='SP' class='import'>Spain</text>
	<line x1='800' x2='800' y1='413' y2='426' style='stroke:grey;stroke-width:2' />

	<text x='850' y='442' id='PL' class='import'>Poland</text>
	<line x1='800' x2='800' y1='436' y2='447' style='stroke:grey;stroke-width:2' />

	<text x='850' y='462' id='CZ' class='import'>Czech Republic</text>
	<line x1='800' x2='800' y1='457' y2='467' style='stroke:grey;stroke-width:2' />

	<text x='850' y='481' id='AT' class='import'>Austria</text>
	<line x1='800' x2='800' y1='477' y2='485' style='stroke:grey;stroke-width:2' />

	<text x='850' y='498' id='HR' class='import'>Hungary</text>
	<line x1='800' x2='800' y1='495' y2='501' style='stroke:grey;stroke-width:2' />

	<text x='850' y='514' id='IR' class='import'>Ireland</text>
	<line x1='800' x2='800' y1='511' y2='516' style='stroke:grey;stroke-width:2' />-->
	

</svg>
</body>
</html>