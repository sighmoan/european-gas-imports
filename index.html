<html>
<head>

<link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/theleagueof/ostrich-sans/master/webfonts/ostrich-sans.css">
<link href='http://fonts.googleapis.com/css?family=Molengo' rel='stylesheet' type='text/css'>
<style>

text {
	font-family:'Ostrich Sans';
}

text .sizeLabel {
	stroke:'#d4d4d2';
	.font-family:'Molengo' !important;
}

h4 {
	font-family:'Molengo';
	font-size:12px;

}

h1 {
	font-family:'Molengo';
	font-weight:'regular';
}
</style>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>

/*

TODO:
- Responsive (scales with screen size)
	- Generate exporter labels [x]
	- Generate importer labels [x]
	- Calculate x values from width [x]
	- Redraw graph on change of screen size [x]
	- Use full floats and round in JS [x]
	- Calculate y values
- Auto generate labels [x]
- Improve colouration 
- Vanquish magic numbers
- Tweak label placement to account for line height [x]
	- Add line labels for full exports [ ] / import [x]
- Better font for labels? More readable
- Set a timer for the fadeout [x]
- Add Ukraine by only adding values to the arrays [x]
- Add Libyan exports
- Move colouration to importers / exporters [x]
- Refactor into d3

*/


var Importers = [
	['DE', 86.8, 'Germany',0],
	['IT', 59.7, 'Italy',0],
	['UK', 35.4, 'United Kingdom',0],
	['FR', 35.0, 'France',0],
	['TR', 34.9, 'Turkey',0],
	['UE', 29.8, 'Ukraine',0],
	['BE', 26.2, 'Belgium',0],
	['NL', 14.5, 'Netherlands',0],
	['SP', 13.3, 'Spain',0],
	['PL', 10.9, 'Poland',0],
	['CZ', 10.0, 'Czech Republic',0],
	['AT', 7.6, 'Austria',0],
	['HR', 5.9, 'Hungary',0],
	['IR', 5.3, 'Ireland',0],
]

var Exporters = [
	['RU', 185.9, 'Russia', 0, '#FF3B2F'],
	['NO', 106.6, 'Norway', 0, '#71CC58'],
	['NL', 54.5, 'Netherlands', 0, '#76B6CC'],
	['UK', 12.0, 'United Kingdom', 0, '#E28922'],
	['AL', 34.8, 'Algeria', 0, '#1F94E8'],
	['LB', 6.5, 'Libya', 0, '#ffa500']
]

var Paths = [
	['RUDE', 30.0],
	['RUIT', 13.6],
	['RUFR', 7.3],
	['RUTR', 24.5],
	['RUUE', 29.8],
	['RUBE', 7.3],
	['RUNL', 2.1],
	['RUPL', 9.0],
	['RUCZ', 6.6],
	['RUAT', 4.7],
	['RUHR', 4.8],
	['NLDE', 25.3],
	['NLIT', 6.8],
	['NLUK', 7.3],
	['NLFR', 9.4],
	['NLBE', 5.2],
	['NODE', 30.8],
	['NOIT', 6.3],
	['NOUK', 26.8],
	['NOFR', 17.9],
	['NOBE', 9.0],
	['NONL', 8.0],
	['NOSP', 2.3],
	['NOCZ', 3.4],
	['NOAT', 1.3],
	['UKBE', 4.6],
	['UKNL', 2.1],
	['UKIR', 5.3],
	['ALIT', 21],
	['ALSP', 10],
	['LBIT', 6.5]
]

function drawGraphs(svg, height, width) {

	svg.empty();

	var lineHeight = 12;
	var xExport = 200;
	var xImport = width - 300;

	svg.selectAll('.importLine')
		.data(Exporters)
		.enter()
		.append('line')
		.attr('x1', xExport)
		.attr('x2', xExport)
		.attr('y1', function(d,i) { if(i==0) d[3] = 50; else d[3] = Exporters[i-1][3] + Exporters[i-1][1] + 10; return d[3] })
		.attr('y2', function(d,i) { return d[3] + d[1] })
		.attr('stroke', 'grey')
		.attr('stroke-width', 2);

	svg.selectAll('.export')
		.data(Exporters)
		.enter()
		.append('text')
		.text(function(d) {return d[2]})
		.attr('x', xExport - 120)
		.attr('y', function(d,i) { return d[1]/2 + d[3] + (lineHeight /2) })
		.attr('text-anchor', 'start')
		.attr('class', 'export')
		.attr('id', function(d) { return d[0] });

	svg.selectAll('.sizeLabel .export')
		.data(Exporters)
		.enter()
		.append('text')
		.text(function (d) { return d[1] + ' bcm'})
		.attr('x', xExport - 125)
		.attr('y', function(d, i) { 
			var yL = Math.floor(d[3] + (Math.round(d[1])/2) + (lineHeight / 2)); 
			return yL;
		})
		.attr('text-anchor', 'end')
		.attr('opacity', 0.3)
		.attr('class', 'sizeLabel')
		.attr('class', 'export');

	svg.selectAll('.importLine')
		.data(Importers)
		.enter()
		.append('line')
		.attr('x1', xImport)
		.attr('x2', xImport)
		.attr('y1', function(d,i) { if(i==0) d[3] = 50; else d[3] = Importers[i-1][3] + Importers[i-1][1] + 10; return d[3] })
		.attr('y2', function(d,i) { return d[3] + d[1] })
		.attr('stroke', 'grey')
		.attr('stroke-width', 2);

	svg.selectAll('.import')
		.data(Importers)
		.enter()
		.append('text')
		.text(function(d) {return d[2]})
		.attr('x', xImport + 120)
		.attr('y', function(d,i) { return d[1]/2 + d[3] + (lineHeight /2) })
		.attr('text-anchor', 'end')
		.attr('class', 'import')
		.attr('id', function(d) {return d[0]});

	svg.selectAll('.sizeLabel .import')
		.data(Importers)
		.enter()
		.append('text')
		.text(function (d) { return d[1] + ' bcm'})
		.attr('x', xImport + 125)
		.attr('y', function(d, i) { 
			var yL = Math.floor(d[3] + (Math.round(d[1])/2) + (lineHeight / 2)); 
			return yL;
		})
		.attr('text-anchor', 'start')
		.attr('opacity', 0.3)
		.attr('class', 'sizeLabel')
		.attr('class', 'import');

	for(var i = 0; i < Paths.length; i++) {
		var data = 'M';
		var y1 = -1;
		var y2 = -1;
		
		//get name of path
		var name = Paths[i][0];
		//get first 2 characters of name
		var exportCountry = name.substring(0, 2);
		//get current cImports for that country code
		var exportCountryIndex = 0;

		for(exportCountryIndex = 0; exportCountryIndex < Exporters.length; exportCountryIndex++) {
			if(Exporters[exportCountryIndex][0] == exportCountry) {
				y1 = Exporters[exportCountryIndex][3];
				break;
			}
		}

		//get last 2 characters of name
		var importCountry = name.substring(2, 4);
		//get current cExports for that country code
		var importCountryIndex = 0;
		//console.log('import country is '+importCountry);
		for(importCountryIndex = 0; importCountryIndex < Importers.length; importCountryIndex++) {
			if(Importers[importCountryIndex][0] == importCountry) {
				y2 = Importers[importCountryIndex][3];
				break;
			}
		}

		var mx = xImport - xExport;

		data += ' '+ xExport + ' ' + y1;
		
		data += ' C '+mx+','+y1+' '+mx+','+y2+' '+xImport+','+y2;

		//add width to y2
		y2 += Math.round(Paths[i][1])
		data += ' L '+xImport+' ' + y2;

		//add bezier control points

		y1 += Math.round(Paths[i][1])
		data += ' C '+mx+','+y2+' '+mx+','+y1+' '+xExport+','+y1;
		

		Exporters[exportCountryIndex][3] = y1;
		Importers[importCountryIndex][3] = y2;



		svg.append('path')
			.attr('d', data)
			.attr('id', name)
			.attr('stroke', 'none')
			.attr('fill', Exporters[exportCountryIndex][4]);

		var importPosition = y1 - (Paths[i][1] / 2) + 7;

		
		var pcImports = (Paths[i][1] / Importers[importCountryIndex][1] * 100).toFixed(1);
		svg.append('text')
			.attr('x', xExport - 30)
			.attr('y', importPosition)
			.attr('class', 'axisLabel import'+importCountry)
			.text(pcImports + " %");

		var pcExports = (Paths[i][1] / Exporters[exportCountryIndex][1] * 100).toFixed(1);
		svg.append('text')
			.attr('x', xImport + 10)
			.attr('y', y2 - (Paths[i][1] / 2) + 7)
			.attr('class', 'axisLabel export'+exportCountry)
			.text(pcExports + " %");

	}

	$('.axisLabel').hide();
}

$(document).ready(function() {

	var timer = 0;	

	$( window ).resize(function() {
		$('#chart').empty();
		drawGraphs(d3.select('#chart'), 1000, $('#chart').width());

		$('.export').mouseover(function() {
			var exportCode = '.export' + $(this).attr('id')
			window.clearInterval(timer);
	
			var expr = '[id^=' + $(this).attr('id') + ']';
	
			$('path').not(expr).fadeOut();
			$('.axisLabel').not(exportCode).fadeOut();
	
			$(exportCode).fadeIn();
			$(expr).fadeIn();
		});

		$('.export, .import').mouseout(function() {
			timer = setInterval(function() {			
				$('path').fadeIn();
				$('.axisLabel').fadeOut();
				window.clearInterval(timer);
			}, 600);
		});

		$('.import').mouseover(function() {
			window.clearInterval(timer);

		var thisID= $(this).attr('id');
		var importCode = '.import' + thisID;
		console.log(importCode);

		var expr = '[id$=' + $(this).attr('id') + ']';

		$('path').not(expr).fadeOut();
		$('.axisLabel').not(importCode).fadeOut();
		
		$(importCode).fadeIn();
		$(expr).fadeIn();		
		});
	});

	$(window).resize();

})

</script>

</head>
<body>
<h1>European Natural Gas Imports</h1>
<h4>One pixel = 1 billion cubic metres (2012 figures)<br/>Source: British Petroleum World Energy Report 2013<br/>Hover for detail</h4>

<svg id='chart' style='width:100%; height:80%; min-height:600px; min-width:500px'>
</svg>
</body>
</html>